<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8"/>
    
    <style>
	.canvas-wrapper {
	    position: relative;
	}

	.canvas-wrapper:before{
	            content:"";
	            display: block;
	            padding-top: 50%;
	}

	.canvas-wrapper canvas {
	    position: absolute;
	    top: 0;
	    left: 0;
	}
     </style>
</head>
    
<script src="https://miro.com/app/static/sdk.1.1.js"></script>
<script src="./js/const.js"></script>
<body onload="loadImage()">
<form>

    <input type="file" name="selfile" accept='.jpg' required><br>

    <div class="canvas-wrapper">
	<canvas id = "canvas2" width="446" height="250"></canvas>
 	<canvas id = "canvas" width="446" height="250"></canvas><br>

    <!-- <img src="" name="image1" height='200' width='167'><br> -->

    	作業スタッフ番号：<input type='text' name="emploee_id" onchange="drawText(this.name, 60)"><br>
	作業スタッフ氏名：<input type='text' name="emploee_name" onchange="drawText(this.name, 110)"><br>
	作業時間  ：<input type='text' name="working_hour" onchange="drawText(this.name, 160)"><br><br>

	<input type='hidden' name='dataurl'><br>
    <input type='hidden' name='oldwidghtId'><br>

	<button type="button" name='register' onclick='createWidgets(false)'>登録</button>
    <button type="button" name='copy' onclick='createWidgets(true)' disabled>複製</button>
	<button type="button" id="close" onclick='closeWindow()'>閉じる</button>
    </div>    

</form>


<script>

    miro.onReady(() => {
        getCardInfo();
    });

    async function  getCardInfo(){
        let selectedWidgets = await miro.board.selection.get();
        let images = selectedWidgets.filter((widget) => widget.type === 'IMAGE');

        if(images.length !== 0){

            var tojson = JSON.stringify(images[0].metadata);
            var fromjson = JSON.parse(tojson);

            if(([client_id] in fromjson) && ('staffid' in fromjson[client_id])){

                document.getElementsByName("copy")[0].disabled=false;

                var staffid = fromjson[client_id]['staffid'];
                var staffName = fromjson[client_id]['staffName'];
                var workHour = fromjson[client_id]['working_hour'];

                document.getElementsByName("emploee_id")[0].value = staffid;
                document.getElementsByName("emploee_name")[0].value = staffName;
                document.getElementsByName("working_hour")[0].value = workHour;
                document.getElementsByName("oldwidghtId")[0].value = images[0].id;
                
                var loadimage = new Image();
                await fetch(api_uri + 'loadimage/' + staffid + '.png' , {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                }).then(function (response) {
                    return response.blob();
                }).then(function(blob) {
                    var objectURL = URL.createObjectURL(blob);
                    loadimage.src = objectURL;
                });


                loadimage.onload = (function () {
                    //画像ロードが完了してからキャンバスの準備をする
                    var canvas = document.getElementById('canvas');
                    var ctx = canvas.getContext('2d');
                    //キャンバスのサイズを画像サイズに合わせる
                    canvas.width = loadimage.width;
                    canvas.height = loadimage.height;
                    //キャンバスに画像を描画（開始位置0,0）
                    ctx.drawImage(loadimage, 0, 0);
                    // DataUrlをクリア
                    document.getElementsByName('dataurl')[0].value = "";

                });

            }
        }	       

    }

    async function loadImage(){
        //画像を読み込んでImageオブジェクトを作成する

        // 初期画像(テキスト等なし)
        var image = new Image();
        image.src = './img/sticker.png';
        image.onload = (function () {
            //画像ロードが完了してからキャンバスの準備をする
            var canvas = document.getElementById('canvas2');
            var ctx = canvas.getContext('2d');
            //キャンバスのサイズを画像サイズに合わせる
                canvas.width = image.width;
                canvas.height = image.height;
            //キャンバスに画像を描画（開始位置0,0）
            ctx.drawImage(image, 0, 0);
            // DataUrlをクリア
            document.getElementsByName('dataurl')[0].value = "";
        });  
    } 

        var obj1 = document.getElementsByName("selfile");
        
        //ダイアログでファイル選択時にCanvas内に画像を表示する
        obj1[0].addEventListener("change",function(evt){

            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            var imagefile = evt.target.files[0];


            var blobUrl = window.URL.createObjectURL(imagefile);

            var image = new Image();
            image.src = blobUrl;


            image.addEventListener('load', function(){
                // 一旦写真の範囲をクリア
                clearPicture(context, 10, 10, 170, 210);                    
                context.drawImage(image,20,20, 167, 200);
            }, false);
	    
        
        },false);


        // Canvas内に文字を表示する
        function drawText(name, ypos){
            var text = document.getElementsByName(name);

            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');

            context.font = '40px serif';
            context.fillStyle = '#404040';
            // 右寄せで表示
            context.textBaseline = 'center';
            context.textAlign = 'right';
            //座標を指定して文字を描く
            var x = (canvas.width -30);
            var y = (canvas.offsetTop + ypos);
       		clearText(context, x-220, ypos - 33);           // 範囲クリア位置調整
            context.fillText(text[0].value, x, y);
        }

        // アップロード確定時にCanvasを合成する(編集用と確定用　編集用はクリア処理が入るため)
        async function concatCanvas(){
            const canvas = document.getElementById('canvas2');
            const ctx = canvas.getContext("2d");

            const image1 = await getImagefromCanvas('canvas');
            ctx.drawImage(image1, 0, 0, canvas.width, canvas.height);
        }

        // Canvasオブジェクトからイメージを取得する
        function getImagefromCanvas(id){
            return new Promise((resolve, reject) => {
                const image = new Image();
                const ctx = document.getElementById(id).getContext("2d");
                image.onload = () => resolve(image);
                image.onerror = (e) => reject(e);
                image.src = ctx.canvas.toDataURL();
            });                            
        }

        // 編集用のCanvasから文字をクリアする
        function clearText(context, x,y){
            context.clearRect(x, y, 300, 45);
        }

        // 編集用のCanvasから写真をクリアする
        function clearPicture(context, x, y, width, height){
            context.clearRect(x, y, width, height);
        }

        // 画面を閉じる
        function closeWindow(){
            miro.board.ui.closeModal();
        }

        // Widgetを作成して画面を閉じる
        async function createWidgets(copyFlag){

            if(confirm('データをアップロードします。よろしいですか？') === false) {
	            return false;
	        }

            document.body.style.cursor = 'wait'; 

	        // アップロード前に一旦送信用画像情報をクリア
	        await loadImage();
		    await concatCanvas();

	    	document.getElementsByName('dataurl')[0].value = await document.getElementById('canvas2').toDataURL();

            setTimeout(function(){
                if(document.getElementsByName('dataurl')[0].value === ""){
                    return false;
                }
            })

            // 合成された画像の一時ファイルを作成
            var emploee_id = document.getElementsByName("emploee_id")[0].value;
            var emploee_name = document.getElementsByName("emploee_name")[0].value;
            var working_hour = document.getElementsByName("working_hour")[0].value;
            var dataurl = document.getElementsByName('dataurl')[0].value;
            await fetch(api_uri + 'create', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'emploee_id' : emploee_id , 'dataurl' : dataurl })
            }).then(function (response) {
                console.log(response.text());
            }).then(function (text) {
                console.log("RESULT: " + text);
            });

            if(copyFlag === true){
                // 複製
                var oldid = document.getElementsByName("oldwidghtId")[0].value;
                if(oldid){
                    // 既存カードの編集の場合
                    var oldwidget = await miro.board.widgets.get({id: oldid});
                    // 元カードの削除
                    await miro.board.widgets.deleteById(oldwidget[0].id);
                    // Widgetの作成
                    await miro.board.widgets.create({ type: 'image', x: oldwidget[0].x, y: oldwidget[0].y, scale: 0.8, url: api_uri + emploee_id + '.png', metadata:{[client_id] :{staffid: emploee_id, staffName: emploee_name, working_hour: working_hour}}});

                }else{
                    // Widgetの新規作成
                    await miro.board.widgets.create({ type: 'image', scale: 0.8, url: api_uri + emploee_id + '.png', metadata:{[client_id] :{staffid: emploee_id, staffName: emploee_name, working_hour: working_hour}}});
                }
            }else{
                // 新規登録
                await miro.board.widgets.create({ type: 'image', scale: 0.8, url: api_uri + emploee_id + '.png', metadata:{[client_id] :{staffid: emploee_id, staffName: emploee_name, working_hour: working_hour}}});
            }


            // 一時ファイルの削除
            await fetch(api_uri + emploee_id  + '.png' , {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: '{}'
            }).then(function (response) {
                console.log(response.text());
            }).then(function (text) {
                console.log("RESULT: " + text);
            });

            document.body.style.cursor = 'auto'; 

            // ModalWindowを閉じる
            miro.board.ui.closeModal()

        }


    </script>        
  </body>    
    
</html>
